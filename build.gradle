plugins {
    id 'dev.architectury.loom' version '1.11-SNAPSHOT' apply false
    id 'architectury-plugin' version '3.4-SNAPSHOT'
    id 'com.github.johnrengelman.shadow' version '8.1.1' apply false
}

architectury {
    minecraft = rootProject.minecraft_version
}

allprojects {
    group = rootProject.maven_group
    version = rootProject.mod_version
}


subprojects {
    apply plugin: 'dev.architectury.loom'
    apply plugin: 'architectury-plugin'
    apply plugin: 'maven-publish'

    base {
        // Set up a suffixed format for the mod jar names, e.g. `example-fabric`.
        archivesName = "$rootProject.archives_name-$project.name"
    }

    repositories {
        // Add repositories to retrieve artifacts from in here.
        // You should only use this when depending on other mods because
        // Loom adds the essential maven repositories to download Minecraft and libraries from automatically.
        // See https://docs.gradle.org/current/userguide/declaring_repositories.html
        // for more information about repositories.
        maven { url = "https://raw.githubusercontent.com/Fuzss/modresources/main/maven/" }
        maven { url = "https://maven.shedaniel.me/" }
        maven { url = "https://maven.terraformersmc.com/releases/" }
    }

    dependencies {
        minecraft "net.minecraft:minecraft:$rootProject.minecraft_version"
        mappings loom.layered {
            it.mappings("net.fabricmc:yarn:$rootProject.yarn_mappings:v2")
            it.mappings("dev.architectury:yarn-mappings-patch-neoforge:$rootProject.yarn_mappings_patch_neoforge_version")
        }
    }

    java {
        // Loom will automatically attach sourcesJar to a RemapSourcesJar task and to the "build" task
        // if it is present.
        // If you remove this line, sources will not be generated.
        withSourcesJar()

        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    tasks.withType(JavaCompile).configureEach {
        it.options.release = 21
    }

    // Configure Maven publishing.
    publishing {
        publications {
            mavenJava(MavenPublication) {
                artifactId = base.archivesName.get()
                from components.java
            }
        }

        // See https://docs.gradle.org/current/userguide/publishing_maven.html for information on how to set up publishing.
        repositories {
            // Add repositories to publish to here.
            // Notice: This block does NOT have the same function as the block in the top level.
            // The repositories here will be used for publishing your artifact, not for
            // retrieving dependencies.
            maven { url = "https://raw.githubusercontent.com/Fuzss/modresources/main/maven/" }
            maven { url = "https://maven.shedaniel.me/" }
            maven { url = "https://maven.terraformersmc.com/releases/" }
        }
    }



    tasks.register('aggregateJar', Jar) {
        archiveBaseName.set(rootProject.archives_name)
        archiveVersion.set(rootProject.mod_version)
        archiveClassifier.set('aggregated')
        archiveExtension.set('jar')

        // åŒ…å«Commonæ¨¡å—çš„è¾“å‡º
        from(project(':common').sourceSets.main.output)

        // åŒ…å«Fabricæ¨¡å—çš„è¾“å‡º
        from(project(':fabric').sourceSets.main.output) {
            exclude 'net/redstone233/nsp/fabric/**'
        }
        from(project(':fabric').sourceSets.main.output) {
            include 'net/redstone233/nsp/fabric/**'
        }

        // åŒ…å«NeoForgeæ¨¡å—çš„è¾“å‡º
        from(project(':neoforge').sourceSets.main.output) {
            exclude 'net/redstone233/nsp/neoforge/**'
        }
        from(project(':neoforge').sourceSets.main.output) {
            include 'net/redstone233/nsp/neoforge/**'
        }

        // åŒ…å«å„æ¨¡å—çš„èµ„æºæ–‡ä»¶
        from(project(':common').sourceSets.main.resources.srcDirs)
        from(project(':fabric').sourceSets.main.resources.srcDirs)
        from(project(':neoforge').sourceSets.main.resources.srcDirs)

        // å¤„ç†é‡å¤æ–‡ä»¶
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE
        exclude 'fabric.mod.json', 'META-INF/mods.toml'

        // ä¾èµ–å…³ç³»
        dependsOn(
                project(':common').tasks.named('build'),
                project(':fabric').tasks.named('build'),
                project(':neoforge').tasks.named('build')
        )

        doFirst {
            // è®°å½•å¼€å§‹æ—¶é—´
            def startTime = System.currentTimeMillis()
            println "â° æ„å»ºå¼€å§‹æ—¶é—´: ${new Date(startTime).format('HH:mm:ss')}"
            println "ğŸ¯ å¼€å§‹æ„å»ºèšåˆJAR..."
            println "ğŸ“¦ é¡¹ç›®: ${archiveBaseName.get()}-v${archiveVersion.get()}"
            println "ğŸ”§ æ¨¡å—: ğŸŸ¦Common + ğŸŸªFabric + ğŸŸ©NeoForge"
            println ""

            // åˆ›å»ºè¿›åº¦å˜é‡
            def progressSteps = [
                    "ğŸ”„ å‡†å¤‡æ„å»ºç¯å¢ƒ...",
                    "ğŸ“¥ æ”¶é›†Commonæ¨¡å—æ–‡ä»¶...",
                    "ğŸ“¥ æ”¶é›†Fabricæ¨¡å—æ–‡ä»¶...",
                    "ğŸ“¥ æ”¶é›†NeoForgeæ¨¡å—æ–‡ä»¶...",
                    "ğŸ“ åˆå¹¶èµ„æºæ–‡ä»¶...",
                    "ğŸ”§ å¤„ç†é‡å¤æ–‡ä»¶...",
                    "ğŸ“¦ æ‰“åŒ…JARæ–‡ä»¶..."
            ]

            // è¿›åº¦æŒ‡ç¤ºå™¨
            progressSteps.eachWithIndex { step, index ->
                println "[${index + 1}/${progressSteps.size()}] $step"
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´ï¼Œå®é™…æ„å»ºä¸­ä¸éœ€è¦è¿™ä¸ªsleep
                if (project.hasProperty('debugProgress')) {
                    Thread.sleep(200)
                }
            }
            println ""

            // å­˜å‚¨å¼€å§‹æ—¶é—´åˆ°æ‰©å±•å±æ€§ä¸­
            ext.startTime = startTime
        }

        doLast {
            def endTime = System.currentTimeMillis()
            def startTime = ext.startTime
            def duration = endTime - startTime

            // æ ¼å¼åŒ–æŒç»­æ—¶é—´
            def formattedDuration
            if (duration < 1000) {
                formattedDuration = "${duration}ms"
            } else if (duration < 60000) {
                formattedDuration = String.format("%.2fs", duration / 1000.0)
            } else {
                def minutes = duration / 60000
                def seconds = (duration % 60000) / 1000.0
                formattedDuration = String.format("%dm %.2fs", minutes, seconds)
            }

            println ""
            println "âœ… èšåˆJARæ„å»ºå®Œæˆ!"
            println "â±ï¸  æ„å»ºè€—æ—¶: $formattedDuration"
            println "â° å®Œæˆæ—¶é—´: ${new Date(endTime).format('HH:mm:ss')}"

            if (archiveFile.isPresent()) {
                println "ğŸ“‚ è¾“å‡ºä½ç½®: ${archiveFile.get().asFile.absolutePath}"

                // æ˜¾ç¤ºæ–‡ä»¶å¤§å°
                def file = archiveFile.get().asFile
                def fileSize = file.length()
                def formattedSize
                if (fileSize < 1024) {
                    formattedSize = "${fileSize} B"
                } else if (fileSize < 1024 * 1024) {
                    formattedSize = String.format("%.2f KB", fileSize / 1024.0)
                } else {
                    formattedSize = String.format("%.2f MB", fileSize / (1024.0 * 1024.0))
                }
                println "ğŸ“Š æ–‡ä»¶å¤§å°: $formattedSize"
            } else {
                println "âš ï¸  æ— æ³•ç¡®å®šæœ€ç»ˆè¾“å‡ºè·¯å¾„ï¼Œä½†ä»»åŠ¡åº”å·²å®Œæˆã€‚"
            }

            println "ğŸ’¡ æç¤º: å°†æ­¤JARæ–‡ä»¶æ”¾å…¥ Minecraft çš„ mods æ–‡ä»¶å¤¹ä¸­è¿›è¡Œæµ‹è¯•"

            // æ„å»ºå®Œæˆåº†ç¥è¡¨æƒ…
            println ""
            println "ğŸ‰ æ„å»ºæˆåŠŸ! å¿«å»æµ‹è¯•ä½ çš„æ¨¡ç»„å§! ğŸ‰"
        }
    }

    // å¯é€‰ï¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡ç»„ï¼Œæ–¹ä¾¿åœ¨IDEä¸­æŸ¥çœ‹
    tasks.named('aggregateJar') {
        group = 'build'
        description = 'å°†commonã€fabricå’Œneoforgeæ¨¡å—èšåˆåˆ°ä¸€ä¸ªJARæ–‡ä»¶ä¸­'
    }
}


