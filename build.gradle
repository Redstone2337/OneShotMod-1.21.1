plugins {
    id 'dev.architectury.loom' version '1.11-SNAPSHOT' apply false
    id 'architectury-plugin' version '3.4-SNAPSHOT'
    id 'com.github.johnrengelman.shadow' version '8.1.1' apply false
}

architectury {
    minecraft = rootProject.minecraft_version
}

allprojects {
    group = rootProject.maven_group
    version = rootProject.mod_version
}


subprojects {
    apply plugin: 'dev.architectury.loom'
    apply plugin: 'architectury-plugin'
    apply plugin: 'maven-publish'

    base {
        // Set up a suffixed format for the mod jar names, e.g. `example-fabric`.
        archivesName = "$rootProject.archives_name-$project.name"
    }

    repositories {
        // Add repositories to retrieve artifacts from in here.
        // You should only use this when depending on other mods because
        // Loom adds the essential maven repositories to download Minecraft and libraries from automatically.
        // See https://docs.gradle.org/current/userguide/declaring_repositories.html
        // for more information about repositories.
        maven { url = "https://raw.githubusercontent.com/Fuzss/modresources/main/maven/" }
        maven { url = "https://maven.shedaniel.me/" }
        maven { url = "https://maven.terraformersmc.com/releases/" }
    }

    dependencies {
        minecraft "net.minecraft:minecraft:$rootProject.minecraft_version"
        mappings loom.layered {
            it.mappings("net.fabricmc:yarn:$rootProject.yarn_mappings:v2")
            it.mappings("dev.architectury:yarn-mappings-patch-neoforge:$rootProject.yarn_mappings_patch_neoforge_version")
        }
    }

    java {
        // Loom will automatically attach sourcesJar to a RemapSourcesJar task and to the "build" task
        // if it is present.
        // If you remove this line, sources will not be generated.
        withSourcesJar()

        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    tasks.withType(JavaCompile).configureEach {
        it.options.release = 21
    }

    // Configure Maven publishing.
    publishing {
        publications {
            mavenJava(MavenPublication) {
                artifactId = base.archivesName.get()
                from components.java
            }
        }

        // See https://docs.gradle.org/current/userguide/publishing_maven.html for information on how to set up publishing.
        repositories {
            // Add repositories to publish to here.
            // Notice: This block does NOT have the same function as the block in the top level.
            // The repositories here will be used for publishing your artifact, not for
            // retrieving dependencies.
            maven { url = "https://raw.githubusercontent.com/Fuzss/modresources/main/maven/" }
            maven { url = "https://maven.shedaniel.me/" }
            maven { url = "https://maven.terraformersmc.com/releases/" }
        }
    }
}

// èšåˆä»»åŠ¡ - å°†commonã€fabricå’Œneoforgeæ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªJAR
tasks.register('aggregateJar', Jar) {
    archiveBaseName.set("${rootProject.archives_name}")
    archiveClassifier.set('aggregated')
    archiveVersion.set("${rootProject.mod_version}")

    // 1. åŒ…å«Commonæ¨¡å—çš„è¾“å‡º
    from(project(':common').sourceSets.main.output)

    // 2. åŒ…å«Fabricæ¨¡å—çš„è¾“å‡º
    from(project(':fabric').sourceSets.main.output) {
        // æ’é™¤Fabricå¹³å°ç‰¹å®šçš„å®ç°ç±»ï¼Œé¿å…é‡å¤
        exclude 'net/redstone233/nsp/fabric/**'
    }
    // æ˜¾å¼åŒ…å«Fabricå¹³å°ç‰¹å®šçš„å®ç°ç±»
    from(project(':fabric').sourceSets.main.output) {
        include 'net/redstone233/nsp/fabric/**'
    }

    // 3. åŒ…å«NeoForgeæ¨¡å—çš„è¾“å‡º
    from(project(':neoforge').sourceSets.main.output) {
        // æ’é™¤NeoForgeå¹³å°ç‰¹å®šçš„å®ç°ç±»
        exclude 'net/redstone233/nsp/neoforge/**'
    }
    // æ˜¾å¼åŒ…å«NeoForgeå¹³å°ç‰¹å®šçš„å®ç°ç±»
    from(project(':neoforge').sourceSets.main.output) {
        include 'net/redstone233/nsp/neoforge/**'
    }

    // 4. åŒ…å«å„æ¨¡å—çš„èµ„æºæ–‡ä»¶
    from(project(':common').sourceSets.main.resources.srcDirs)
    from(project(':fabric').sourceSets.main.resources.srcDirs)
    from(project(':neoforge').sourceSets.main.resources.srcDirs)

    // 5. å¤„ç†é‡å¤æ–‡ä»¶ï¼ˆå¹³å°ç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼‰
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    exclude 'fabric.mod.json', 'META-INF/mods.toml'

    // 6. ç¡®ä¿åœ¨å­é¡¹ç›®æ„å»ºå®Œæˆåæ‰§è¡Œ
    dependsOn(
            project(':common').tasks.named('build'),
            project(':fabric').tasks.named('build'),
            project(':neoforge').tasks.named('build')
    )

    doFirst {
        println "ğŸ¯ å¼€å§‹æ„å»ºèšåˆJARä»»åŠ¡..."
        println "ğŸ“¦ é¡¹ç›®ä¿¡æ¯: ${rootProject.archives_name}-v${rootProject.mod_version}"
        println "ğŸ”§ åŒ…å«æ¨¡å—:"
        println "   â€¢ ğŸŸ¦ Commonæ¨¡å— (æ ¸å¿ƒé€»è¾‘)"
        println "   â€¢ ğŸŸª Fabricæ¨¡å— (Fabricå¹³å°å®ç°)"
        println "   â€¢ ğŸŸ© NeoForgeæ¨¡å— (NeoForgeå¹³å°å®ç°)"
        println "ğŸ“ è¾“å‡ºæ–‡ä»¶: ${archiveBaseName.get()}-${archiveVersion.get()}-${archiveClassifier.get()}.jar"
        println "âš¡ å¤„ç†ç­–ç•¥:"
        println "   â€¢ ğŸ”„ æ’é™¤é‡å¤æ–‡ä»¶ç­–ç•¥: ${duplicatesStrategy}"
        println "   â€¢ ğŸš« æ’é™¤çš„æ–‡ä»¶: fabric.mod.json, META-INF/mods.toml"
        println "   â€¢ ğŸ¯ å¹³å°ç‰¹å®šä»£ç : åˆ†åˆ«åŒ…å« Fabric/NeoForge çš„å®ç°ç±»"
        println "â³ æ­£åœ¨èšåˆå„æ¨¡å—çš„ç±»å’Œèµ„æºæ–‡ä»¶..."
    }

    def dots = 0
    def progressTimer = new Timer()
    progressTimer.scheduleAtFixedRate({
        print "\rğŸ“¦ èšåˆä¸­" + "." * (dots % 4) + "   "
        dots++
    }, 0, 500)

    doLast {
        progressTimer.cancel()
        if (archiveFile.isPresent()) {
            println "âœ… èšåˆJARæ„å»ºå®Œæˆ!"
            println "ğŸ“‚ è¾“å‡ºä½ç½®: ${archiveFile.get().asFile.absolutePath}"
            println "ğŸ’¡ æç¤º: å°†æ­¤JARæ–‡ä»¶æ”¾å…¥ Minecraft çš„ mods æ–‡ä»¶å¤¹ä¸­è¿›è¡Œæµ‹è¯•"
        } else {
            println "âŒ æ„å»ºå®Œæˆä½†æ— æ³•ç¡®å®šè¾“å‡ºæ–‡ä»¶"
        }
    }
}

// å¯é€‰ï¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡ç»„ï¼Œæ–¹ä¾¿åœ¨IDEä¸­æŸ¥çœ‹
tasks.named('aggregateJar') {
    group = 'build'
    description = 'å°†commonã€fabricå’Œneoforgeæ¨¡å—èšåˆåˆ°ä¸€ä¸ªJARæ–‡ä»¶ä¸­'
}
